<!doctype html>
<html>
    <head>
        <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
        <title>Camara AR</title>
    </head>
    <body style="margin: 0; overflow: hidden">
        <div id="infoPanel" class="info-panel">
            <div class="header-info">
                <h3 id="titulo">Información</h3>
                <button class="cerrar-boton" onclick="cerrarPanel()">X</button>
            </div>
            <div class="contenido">
                <iframe id="info" src=""></iframe>
            </div>
        </div>

        <a-scene
            embedded
            arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        >
            <a-marker
                id="markerLlama"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/sus.patt"
            >
            </a-marker>

            <a-marker
                id="markerMictlantecuhtli"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/mictlantecuchil.patt"
            >
            </a-marker>

            <a-marker
                id="markerMapa"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/mapa.patt"
            >
            </a-marker>

            <a-marker
                id="markerMascara"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/mascara.patt"
            >
            </a-marker>

            <a-marker
                id="markerTumbaTotonaca"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/templo%20prehispanico.patt"
            >
            </a-marker>

            <a-marker
                id="markerTlazoltetl"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/escultura%20antropomorfa.patt"
            >
            </a-marker>

            <a-marker
                id="markerZoomorfa"
                type="pattern"
                url="https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/patt/vasija_zoomorfa.patt"
            >
            </a-marker>

            <a-entity
                id="camera"
                camera
                look-controls
                wasd-controls="acceleration: 15"
                position="0 1.6 0"
            ></a-entity>
        </a-scene>

        <script>
            const scene = document.querySelector("a-scene");
            const camera = document.querySelector("#camera");
            const infoPanel = document.getElementById("infoPanel");
            const iframe = document.getElementById("info");
            const titulo = document.getElementById("titulo");

            const markers = [
                {
                    id: "markerLlama",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/llama.glb",
                    infoUrl: "mictlantecuhtli.html",
                    titulo: "llama",
                    position: "0 0 0",
                    rotation: "0 0 0",
                    scale: "0.02 0.02 0.02",
                    distance: 2,
                    loaded: false,
                    fixedModel: null,
                },
                {
                    id: "markerMictlantecuhtli",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/mictlantecuhtli.glb",
                    infoUrl: "mictlantecuhtli.html",
                    titulo: "Mictlantecuhtli",
                    position: "0 3 0",
                    rotation: "0 0 0",
                    scale: "5 5 5",
                    distance: 6,
                    loaded: false,
                    fixedModel: null,
                },
                {
                    id: "markerMapa",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/mapa.glb",
                    infoUrl: "mictlantecuhtli.html",
                    titulo: "Mapa",
                    position: "0 0 0",
                    rotation: "0 0 0",
                    scale: "15 15 15",
                    distance: 5,
                    loaded: false,
                    fixedModel: null,
                },
                {
                    id: "markerMascara",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/Mascara_de_jade.glb",
                    infoUrl: "mascara.html",
                    titulo: "Máscara de Jade",
                    position: "0 3 0",
                    rotation: "0 0 0",
                    scale: "4 4 4",
                    distance: 5,
                    loaded: false,
                    fixedModel: null,
                },
                {
                    id: "markerTumbaTotonaca",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/Tumba_totonaca.glb",
                    infoUrl: "Tumba_totonaca.html",
                    titulo: "Tumba Totonaca",
                    position: "0 0 0",
                    rotation: "0 0 0",
                    scale: "1 1 1",
                    distance: 5,
                    loaded: false,
                    fixedModel: null,
                },
                {
                    id: "markerTlazoltetl",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/Diosa_Tlazoltotl.glb",
                    infoUrl: "Diosa_Tlazototl.html",
                    titulo: "Diosa Tlazototl",
                    position: "0 0 0",
                    rotation: "0 0 0",
                    scale: "1 1 1",
                    distance: 5,
                    loaded: false,
                    fixedModel: null,
                },
                {
                    id: "markerZoomorfa",
                    modelUrl:
                        "https://cdn.jsdelivr.net/gh/Hiramrr/XalapAR-2@main/modelos/Recipientes_zoomorfos.glb",
                    infoUrl: "zoomorfo.html",
                    titulo: "Recipiente zoomorfo",
                    position: "0 0 0",
                    rotation: "0 0 0",
                    scale: "30 30 30",
                    distance: 0.7,
                    loaded: false,
                    fixedModel: null,
                },
            ];

            // De aqui para abajo no se toca absolutamente nada - si se mueve algo 100 pesos
            markers.forEach((markerConfig) => {
                const marker = document.querySelector(`#${markerConfig.id}`);
                if (!marker) return console.warn("Marcador no encontrado");

                marker.addEventListener("markerFound", () => {
                    if (markerConfig.fixedModel) return;

                    // Eliminar todos los modelos existentes antes de mostrar uno nuevo
                    quitarModelos();

                    const model = document.createElement("a-entity");
                    model.setAttribute("id", `model_${markerConfig.id}`);
                    model.setAttribute("gltf-model", markerConfig.modelUrl);
                    model.setAttribute("scale", markerConfig.scale);

                    const THREEAF = AFRAME.THREE;
                    const camera = scene.camera;

                    const pos = new THREEAF.Vector3();
                    camera.getWorldPosition(pos);

                    const direction = new THREEAF.Vector3(0, 0, -1)
                        .applyQuaternion(camera.quaternion)
                        .multiplyScalar(markerConfig.distance);

                    // const offset = new THREEAF.Vector3(
                    //     ...markerConfig.position.split(" ").map(Number),
                    // );
                    // pos.add(direction).add(offset);

                    pos.add(direction);

                    model.setAttribute(
                        "position",
                        `${pos.x} ${pos.y} ${pos.z}`,
                    );

                    const camRot = new THREEAF.Euler().setFromQuaternion(
                        camera.quaternion,
                    );

                    scene.appendChild(model);
                    markerConfig.fixedModel = model;
                    markerConfig.loaded = true;

                    abrirPanel(markerConfig.titulo, markerConfig.infoUrl);
                });
            });

            document.addEventListener("keydown", (e) => {
                const pos = camera.getAttribute("position");
                if (e.key === "q" || e.key === "Q") pos.y += 0.1;
                if (e.key === "e" || e.key === "E") pos.y -= 0.1;
                camera.setAttribute("position", pos);
            });

            function cerrarPanel() {
                infoPanel.classList.remove("active");
                iframe.src = "";
                quitarModelos();
            }

            function abrirPanel(tituloTexto, url) {
                titulo.textContent = tituloTexto;
                iframe.src = url;
                infoPanel.classList.add("active");
            }

            function quitarModelos() {
                markers.forEach((m) => {
                    if (m.fixedModel) {
                        m.fixedModel.parentNode.removeChild(m.fixedModel);
                        m.fixedModel = null;
                        m.loaded = false;
                    }
                });
            }
        </script>
    </body>
</html>

<style>
    .info-panel {
        position: fixed;
        top: 0;
        left: -420px;
        width: 400px;
        height: 100vh;
        background-color: rgba(255, 255, 255, 0.95);
        transition: left 0.3s ease;
        display: flex;
        flex-direction: column;
        z-index: 1000;
    }

    .info-panel.active {
        left: 0;
    }

    .header-info {
        padding: 15px;
        background-color: #333;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-info h3 {
        margin: 0;
        font-size: 20px;
        font-family: Arial, sans-serif;
    }

    .cerrar-boton {
        background-color: #ff4444;
        color: white;
        border: none;
        width: 30px;
        height: 30px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: background-color 0.2s;
    }

    .cerrar-boton:hover {
        background-color: #cc0000;
    }

    .contenido {
        flex: 1;
        overflow: hidden;
    }

    iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
</style>
